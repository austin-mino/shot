<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>Final Android Shooter</title>

<style>
body {
    margin: 0;
    overflow: hidden;
    background: #111;
    user-select: none;
    font-family: sans-serif;
}

/* UI */
#ui-layer {
    position: absolute;
    top: 20px;
    left: 20px;
    z-index: 10;
    pointer-events: none;
}
.stat-box {
    display: inline-block;
    background: rgba(0,0,0,0.6);
    color: white;
    padding: 10px 20px;
    border-radius: 8px;
    margin-right: 10px;
    font-size: 18px;
    font-weight: bold;
}
#hp-bar { color: #ff5555; }
#score-bar { color: #55ff55; }

/* Crosshair */
#crosshair {
    position: fixed;
    top: 50%; left: 50%;
    width: 20px; height: 20px;
    transform: translate(-50%, -50%);
    pointer-events: none;
}
#crosshair::before, #crosshair::after {
    content: '';
    position: absolute;
    background: white;
}
#crosshair::before { width: 20px; height: 2px; top: 9px; left: 0; }
#crosshair::after { width: 2px; height: 20px; left: 9px; top: 0; }

/* Damage */
#damage-overlay {
    position: fixed;
    inset: 0;
    background: red;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s;
}

/* Game Over */
#game-over {
    position: fixed;
    inset: 0;
    display: none;
    background: rgba(0,0,0,0.85);
    color: white;
    justify-content: center;
    align-items: center;
    flex-direction: column;
    z-index: 20;
}
#game-over h1 {
    font-size: 70px;
    color: #ff3333;
}
#game-over button {
    padding: 15px 40px;
    font-size: 22px;
    cursor: pointer;
    border-radius: 40px;
    border: none;
}
</style>
</head>

<body>
<div id="ui-layer">
    <div class="stat-box" id="hp-bar">HP: 100</div>
    <div class="stat-box" id="score-bar">SCORE: 0</div>
</div>

<div id="crosshair"></div>
<div id="damage-overlay"></div>

<div id="game-over">
    <h1>GAME OVER</h1>
    <p>Final Score: <span id="final-score">0</span></p>
    <button onclick="location.reload()">RESTART</button>
</div>

<script type="importmap">
{
  "imports": {
    "three": "https://unpkg.com/three@0.160.0/build/three.module.js"
  }
}
</script>

<script type="module">
import * as THREE from 'three';

/* ================= 상태 ================= */
let hp = 100;
let score = 0;
let isGameOver = false;

const bullets = [];
const enemies = [];
const debris = [];

const keys = {};
let shootCooldown = 0;

/* ================= 시야 ================= */
let yaw = 0;
let pitch = -0.3;
const sensitivity = 0.002;

/* ================= 씬 ================= */
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x222222);
scene.fog = new THREE.FogExp2(0x222222, 0.02);

const camera = new THREE.PerspectiveCamera(75, innerWidth / innerHeight, 0.1, 1000);
const renderer = new THREE.WebGLRenderer({ antialias: true });
renderer.setSize(innerWidth, innerHeight);
renderer.shadowMap.enabled = true;
document.body.appendChild(renderer.domElement);

/* ================= 라이트 ================= */
scene.add(new THREE.AmbientLight(0x404050, 0.6));
const light = new THREE.DirectionalLight(0xffeedd, 2);
light.position.set(30, 50, 30);
light.castShadow = true;
scene.add(light);

/* ================= 바닥 ================= */
const ground = new THREE.Mesh(
    new THREE.PlaneGeometry(300,300),
    new THREE.MeshStandardMaterial({ color: 0x444444 })
);
ground.rotation.x = -Math.PI / 2;
ground.receiveShadow = true;
scene.add(ground);

/* ================= 캐릭터 ================= */
function createHumanoid(color) {
    const g = new THREE.Group();
    const m = new THREE.MeshStandardMaterial({ color });

    const body = new THREE.Mesh(new THREE.CylinderGeometry(0.35,0.3,1.2,16), m);
    body.position.y = 1.6;
    g.add(body);

    const head = new THREE.Mesh(new THREE.SphereGeometry(0.3,16,16), m);
    head.position.y = 2.4;
    g.add(head);

    g.castShadow = true;
    return g;
}

const player = createHumanoid(0x0088ff);
scene.add(player);

/* ================= 입력 ================= */
document.body.addEventListener('click', () => {
    document.body.requestPointerLock();
});

addEventListener('mousemove', e => {
    if (document.pointerLockElement !== document.body || isGameOver) return;
    yaw -= e.movementX * sensitivity;
    pitch -= e.movementY * sensitivity;
    pitch = THREE.MathUtils.clamp(pitch, -1.2, 0.4);
});

addEventListener('keydown', e => keys[e.key.toLowerCase()] = true);
addEventListener('keyup', e => keys[e.key.toLowerCase()] = false);

/* ================= 총 ================= */
addEventListener('mousedown', () => {
    if (shootCooldown > 0 || isGameOver) return;
    shootCooldown = 10;

    const bullet = new THREE.Mesh(
        new THREE.BoxGeometry(0.1,0.1,0.6),
        new THREE.MeshBasicMaterial({ color: 0xffaa00 })
    );

    const dir = new THREE.Vector3();
    camera.getWorldDirection(dir);

    bullet.position.copy(player.position).add(new THREE.Vector3(0,2,0));
    scene.add(bullet);

    bullets.push({ mesh: bullet, vel: dir.multiplyScalar(3), life: 80 });
});

/* ================= 적 ================= */
setInterval(() => {
    if (enemies.length > 10 || isGameOver) return;
    const e = createHumanoid(0xff4444);
    const a = Math.random() * Math.PI * 2;
    e.position.set(
        player.position.x + Math.cos(a)*40,
        0,
        player.position.z + Math.sin(a)*40
    );
    scene.add(e);
    enemies.push(e);
}, 2000);

/* ================= UI ================= */
function updateUI() {
    hpBar.innerText = `HP: ${hp}`;
    scoreBar.innerText = `SCORE: ${score}`;
}

function damage() {
    hp -= 20;
    document.getElementById('damage-overlay').style.opacity = 0.5;
    setTimeout(()=>damageOverlay.style.opacity=0,200);
    if (hp <= 0) gameOver();
    updateUI();
}

function gameOver() {
    isGameOver = true;
    finalScore.innerText = score;
    gameOverBox.style.display = 'flex';
}

/* ================= 루프 ================= */
function animate() {
    requestAnimationFrame(animate);
    if (isGameOver) return;

    shootCooldown = Math.max(0, shootCooldown-1);

    /* 이동 */
    const speed = keys.shift ? 0.35 : 0.2;
    if (keys.w) player.translateZ(-speed);
    if (keys.s) player.translateZ(speed);
    if (keys.a) player.translateX(-speed);
    if (keys.d) player.translateX(speed);

    player.rotation.y = yaw;

    /* 카메라 */
    const dist = 15;
    camera.position.set(
        player.position.x + Math.sin(yaw)*dist,
        player.position.y + 6 + Math.sin(pitch)*4,
        player.position.z + Math.cos(yaw)*dist
    );
    camera.lookAt(player.position.x, player.position.y+2, player.position.z);

    /* 총알 */
    bullets.forEach((b,i)=>{
        b.mesh.position.add(b.vel);
        b.life--;
        enemies.forEach((e,j)=>{
            if (b.mesh.position.distanceTo(e.position.clone().add(new THREE.Vector3(0,1.5,0))) < 1.3) {
                scene.remove(e); enemies.splice(j,1);
                scene.remove(b.mesh); bullets.splice(i,1);
                score+=100; updateUI();
            }
        });
        if (b.life<=0) {
            scene.remove(b.mesh); bullets.splice(i,1);
        }
    });

    /* 적 */
    enemies.forEach(e=>{
        e.lookAt(player.position);
        e.translateZ(0.06);
        if (e.position.distanceTo(player.position) < 1) {
            damage();
            e.translateZ(-3);
        }
    });

    renderer.render(scene,camera);
}
animate();

addEventListener('resize',()=>{
    camera.aspect = innerWidth/innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(innerWidth,innerHeight);
});
</script>
</body>
</html>
