<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>SHOT GAME FINAL</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
<style>
body{margin:0;overflow:hidden;background:#000;touch-action:none}
canvas{display:block}
#ui{position:absolute;top:10px;left:10px;color:#fff;font-family:sans-serif;z-index:5}
.bar{background:rgba(0,0,0,.6);padding:6px 12px;border-radius:6px;margin-bottom:4px}
#bossBar{position:absolute;top:10px;left:50%;transform:translateX(-50%);width:300px;height:18px;background:#300;border-radius:9px;display:none}
#bossHP{height:100%;width:100%;background:red;border-radius:9px}
#joystick{position:absolute;bottom:20px;left:20px;width:120px;height:120px;border-radius:50%;background:rgba(255,255,255,.1)}
#stick{position:absolute;left:40px;top:40px;width:40px;height:40px;border-radius:50%;background:rgba(255,255,255,.5)}
.btn{position:absolute;width:70px;height:70px;border-radius:50%;background:rgba(255,255,255,.25);color:#fff;display:flex;align-items:center;justify-content:center}
#shootBtn{right:30px;bottom:40px}
#jumpBtn{right:120px;bottom:120px}
</style>
</head>
<body>

<div id="ui">
  <div class="bar" id="hp">HP:100</div>
  <div class="bar" id="score">SCORE:0</div>
</div>
<div id="bossBar"><div id="bossHP"></div></div>

<div id="joystick"><div id="stick"></div></div>
<div class="btn" id="shootBtn">SHOOT</div>
<div class="btn" id="jumpBtn">JUMP</div>

<script type="module">
import * as THREE from 'https://unpkg.com/three@0.160.0/build/three.module.js';

/* =====================
   기본 변수
===================== */
let score=0,hp=100;
let bullets=[], enemies=[];
let boss=null;
let vy=0, grounded=true;
let keys={};

/* =====================
   씬
===================== */
const scene=new THREE.Scene();
scene.background=new THREE.Color(0x202020);
scene.fog=new THREE.Fog(0x202020,30,180);

const camera=new THREE.PerspectiveCamera(75,innerWidth/innerHeight,.1,500);
const renderer=new THREE.WebGLRenderer({antialias:true});
renderer.setSize(innerWidth,innerHeight);
renderer.shadowMap.enabled=true;
document.body.appendChild(renderer.domElement);

scene.add(new THREE.AmbientLight(0x555555));
const sun=new THREE.DirectionalLight(0xffffff,1.2);
sun.position.set(30,50,30);
sun.castShadow=true;
scene.add(sun);

/* =====================
   바닥
===================== */
const ground=new THREE.Mesh(
  new THREE.PlaneGeometry(500,500),
  new THREE.MeshStandardMaterial({color:0x444444})
);
ground.rotation.x=-Math.PI/2;
ground.receiveShadow=true;
scene.add(ground);

/* =====================
   디테일한 캐릭터
===================== */
function detailedHuman(color){
  const g=new THREE.Group();
  const m=new THREE.MeshStandardMaterial({color});

  const torso=new THREE.Mesh(new THREE.BoxGeometry(.8,1.2,.5),m);
  torso.position.y=2.2; g.add(torso);

  const neck=new THREE.Mesh(new THREE.CylinderGeometry(.15,.15,.2),m);
  neck.position.y=2.9; g.add(neck);

  const head=new THREE.Mesh(new THREE.SphereGeometry(.35),m);
  head.position.y=3.3; g.add(head);

  function arm(x){
    const a=new THREE.Group();
    const u=new THREE.Mesh(new THREE.BoxGeometry(.25,.7,.25),m);
    u.position.y=-.35; a.add(u);
    const l=new THREE.Mesh(new THREE.BoxGeometry(.2,.6,.2),m);
    l.position.y=-1; a.add(l);
    a.position.set(x,2.7,0);
    return a;
  }

  function leg(x){
    const l=new THREE.Group();
    const u=new THREE.Mesh(new THREE.BoxGeometry(.3,.8,.3),m);
    u.position.y=-.4; l.add(u);
    const d=new THREE.Mesh(new THREE.BoxGeometry(.25,.7,.25),m);
    d.position.y=-1.1; l.add(d);
    const f=new THREE.Mesh(new THREE.BoxGeometry(.3,.15,.5),m);
    f.position.set(0,-1.5,.1); l.add(f);
    l.position.set(x,1.4,0);
    return l;
  }

  g.add(arm(-.6),arm(.6),leg(-.25),leg(.25));
  g.traverse(o=>o.castShadow=true);
  return g;
}

const player=detailedHuman(0x00aaff);
scene.add(player);

/* =====================
   입력
===================== */
addEventListener('keydown',e=>keys[e.key.toLowerCase()]=true);
addEventListener('keyup',e=>keys[e.key.toLowerCase()]=false);

/* =====================
   총알
===================== */
function shoot(){
  const b=new THREE.Mesh(
    new THREE.BoxGeometry(.15,.15,.6),
    new THREE.MeshBasicMaterial({color:0xffaa00})
  );
  b.position.copy(player.position);
  b.position.y+=2.5;
  scene.add(b);
  bullets.push({m:b,v:new THREE.Vector3(0,0,-1.5)});
}

/* =====================
   보스
===================== */
function spawnBoss(){
  boss={
    mesh:detailedHuman(0xaa0000),
    hp:5000
  };
  boss.mesh.scale.set(4,4,4);
  boss.mesh.position.set(0,0,-80);
  scene.add(boss.mesh);
  document.getElementById('bossBar').style.display='block';
}

/* =====================
   모바일 UI
===================== */
let joyX=0,joyY=0;
const stick=document.getElementById('stick');

document.getElementById('joystick').ontouchmove=e=>{
  const t=e.touches[0];
  const dx=t.clientX-80;
  const dy=t.clientY-(innerHeight-80);
  joyX=Math.max(-1,Math.min(1,dx/60));
  joyY=Math.max(-1,Math.min(1,dy/60));
  stick.style.left=joyX*40+40+'px';
  stick.style.top=joyY*40+40+'px';
};
document.getElementById('joystick').ontouchend=()=>{
  joyX=joyY=0; stick.style.left='40px'; stick.style.top='40px';
};
shootBtn.ontouchstart=shoot;
jumpBtn.ontouchstart=()=>{if(grounded){vy=.6;grounded=false;}};

/* =====================
   루프
===================== */
function loop(){
  requestAnimationFrame(loop);

  /* 이동 */
  let mx=joyX,my=joyY;
  if(keys.w)my=-1;
  if(keys.s)my=1;
  if(keys.a)mx=-1;
  if(keys.d)mx=1;
  player.position.x+=mx*.25;
  player.position.z+=my*.25;

  /* 중력 */
  vy-=.03;
  player.position.y+=vy;
  if(player.position.y<=0){player.position.y=0;vy=0;grounded=true;}

  /* 총알 */
  bullets.forEach(b=>{
    b.m.position.add(b.v);
    if(boss && b.m.position.distanceTo(boss.mesh.position)<6){
      boss.hp-=20;
      document.getElementById('bossHP').style.width=(boss.hp/5000*100)+'%';
    }
  });

  /* 점수 증가 */
  score++;
  score>15000 && !boss && spawnBoss();
  document.getElementById('score').innerText='SCORE:'+score;

  /* 보스 이동 */
  if(boss){
    boss.mesh.lookAt(player.position);
    boss.mesh.translateZ(.15);
  }

  /* 카메라 */
  camera.position.lerp(player.position.clone().add(new THREE.Vector3(0,18,22)),.1);
  camera.lookAt(player.position);

  renderer.render(scene,camera);
}
loop();

addEventListener('resize',()=>{
  camera.aspect=innerWidth/innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(innerWidth,innerHeight);
});
</script>
</body>
</html>
